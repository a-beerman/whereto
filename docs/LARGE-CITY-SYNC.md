# Синхронизация больших городов

## Проблема

Google Places API имеет ограничения:

- **Максимальный радиус**: 50,000 метров (50 км)
- **Рекомендуемый радиус**: до 20,000 метров (20 км) для лучших результатов
- Для больших городов типа Москвы (диаметр ~50-60 км) один запрос не покрывает весь город

## Решение: Сетка поиска

Система автоматически разбивает большие города на сетку радиусов для полного покрытия.

### Как это работает

1. **Проверка bounds**: Если у города есть `bounds` (границы), используется сетка
2. **Автоматический расчет**: Размер сетки зависит от размера города:
   - Малый город (< 20 км): 3×3 = 9 ячеек
   - Средний город (20-40 км): 5×5 = 25 ячеек
   - Большой город (40-60 км): 7×7 = 49 ячеек
   - Очень большой город (> 60 км): 9×9 = 81 ячейка
3. **Перекрытие**: 20% перекрытие между ячейками, чтобы не пропустить заведения на границах
4. **Дедупликация**: Все результаты дедуплицируются по `place_id`

### Формат bounds в City entity

```typescript
// Вариант 1: Прямой формат
{
  "minLat": 55.5,
  "minLng": 37.3,
  "maxLat": 55.9,
  "maxLng": 37.9
}

// Вариант 2: Google Maps формат
{
  "north": 55.9,
  "south": 55.5,
  "east": 37.9,
  "west": 37.3
}
```

## Примеры для больших городов

### Москва

```json
{
  "name": "Moscow",
  "countryCode": "RU",
  "centerLat": 55.7558,
  "centerLng": 37.6173,
  "bounds": {
    "minLat": 55.4899,
    "minLng": 37.3192,
    "maxLat": 55.9578,
    "maxLng": 37.9677
  }
}
```

**Результат**: Автоматически создастся сетка 7×7 = 49 ячеек, каждая с радиусом ~8 км

### Санкт-Петербург

```json
{
  "name": "Saint Petersburg",
  "countryCode": "RU",
  "centerLat": 59.9343,
  "centerLng": 30.3351,
  "bounds": {
    "minLat": 59.8,
    "minLng": 30.0,
    "maxLat": 60.1,
    "maxLng": 30.7
  }
}
```

**Результат**: Автоматически создастся сетка 5×5 = 25 ячеек

## Стоимость синхронизации

### Для Москвы (7×7 сетка):

- **Ячеек**: 49
- **Типов заведений**: 3 (restaurant, cafe, bar)
- **Запросов Nearby Search**: 49 × 3 = 147 запросов
- **Стоимость**: 147 × $0.032 = **$4.70**

**С пагинацией** (до 3 страниц на тип):

- Максимум: 147 × 3 = 441 запросов
- Стоимость: 441 × $0.032 = **$14.11**

**Place Details** (для получения phone, website):

- Предположим 2000 уникальных заведений
- 2000 × $0.017 = **$34.00**

**Итого для Москвы**: ~$48/синхронизация

**Раз в неделю**: $48 × 4 = **$192/месяц**

### Для Санкт-Петербурга (5×5 сетка):

- **Ячеек**: 25
- **Запросов Nearby Search**: 25 × 3 = 75 запросов
- **Стоимость**: 75 × $0.032 = **$2.40**

**С пагинацией**: до $7.20

**Place Details**: ~$20 (1000 заведений)

**Итого**: ~$27/синхронизация

**Раз в неделю**: $27 × 4 = **$108/месяц**

## Рекомендации

### 1. Добавление bounds для больших городов

При создании города обязательно указывайте `bounds`:

```typescript
const moscow = await cityRepository.create({
  name: 'Moscow',
  countryCode: 'RU',
  centerLat: 55.7558,
  centerLng: 37.6173,
  bounds: {
    minLat: 55.4899,
    minLng: 37.3192,
    maxLat: 55.9578,
    maxLng: 37.9677,
  },
});
```

### 2. Получение bounds

Можно получить bounds из:

- Google Maps Geocoding API
- OpenStreetMap Nominatim API
- Вручную из Google Maps (правый клик → "Что здесь?")

### 3. Оптимизация стоимости

- **Используйте фильтры**: rating >= 3 (уже реализовано)
- **Ограничьте пагинацию**: maxPages = 3 (уже реализовано)
- **Синхронизируйте реже**: раз в неделю вместо ежедневно
- **Только активные города**: не синхронизируйте неактивные города

### 4. Мониторинг

Отслеживайте метрики синхронизации:

- Количество найденных заведений
- Количество созданных/обновленных
- Количество дубликатов
- Ошибки

## Миграция существующих городов

Для существующих городов без bounds:

1. **Вариант 1**: Добавить bounds вручную через SQL:

```sql
UPDATE cities
SET bounds = '{"minLat": 55.4899, "minLng": 37.3192, "maxLat": 55.9578, "maxLng": 37.9677}'::jsonb
WHERE name = 'Moscow';
```

2. **Вариант 2**: Использовать центр + дефолтный радиус (50 км)
   - Система автоматически создаст bounds из центра
   - Может быть недостаточно для очень больших городов

## Тестирование

Для тестирования можно ограничить количество ячеек:

```typescript
// В grid-generator.util.ts временно изменить:
if (maxDimension < 20) {
  return 2; // Тест: 2×2 = 4 ячейки
}
```

Или ограничить MAX_PLACES в sync-city.job.ts для быстрого теста.
